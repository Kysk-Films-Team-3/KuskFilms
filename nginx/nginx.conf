server {
    listen 80;
    server_name localhost;

    client_max_body_size 10G;

    # ==========================================================
    # БЛОК ДЛЯ KEYCLOAK
    # Объединяем правила для /auth/ и /auth/admin/ в одно для простоты
    # ==========================================================
    location /auth/ {
        # ========= НАЧАЛО ИСПРАВЛЕНИЙ ==========
        # Убираем слэш в конце. `proxy_pass http://keycloak:8080;` более надежный вариант.
        # Он корректно передает весь путь (URI) как есть.
        proxy_pass http://keycloak:8080;
        # ========= КОНЕЦ ИСПРАВЛЕНИЙ ============
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==========================================================
    # БЛОК ДЛЯ БЭКЕНДА И SWAGGER
    # Объединяем все правила для API и Swagger в одно
    # ==========================================================
    location /api/ {
        # ========= НАЧАЛО ИСПРАВЛЕНИЙ ==========
        # Убираем /api/ в конце. `proxy_pass http://backend:8081;` передаст
        # запрос `/api/users/profile/me` как `http://backend:8081/api/users/profile/me`.
        # Это более гибко и правильно.
        proxy_pass http://backend:8081;
        # ========= КОНЕЦ ИСПРАВЛЕНИЙ ============
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Отдельные location для swagger больше не нужны, так как они покрываются правилом /api/
    # (если вы изменили путь к swagger в application.yml на /api/swagger-ui.html)
    # Если swagger все еще по корневому пути, то эти правила нужны.
    # Для чистоты я оставлю их, но они могут быть лишними.
    location /swagger-ui {
        proxy_pass http://backend:8081;
    }
    location /v3/api-docs {
        proxy_pass http://backend:8081;
    }


    # ========= НАЧАЛО ИЗМЕНЕНИЙ ==========
    # ДОБАВЛЕН НОВЫЙ БЛОК ДЛЯ MINIO
    # Это правило будет перехватывать все запросы к вашим файлам (аватарам, постерам)
    # и перенаправлять их напрямую на Minio.
    location /kyskfilms/ {
        rewrite ^/kyskfilms/(.*) /$1 break;
         proxy_pass http://minio:9000;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header X-Forwarded-Proto $scheme;
    }
    # ========= КОНЕЦ ИЗМЕНЕНИЙ ============


    # ==========================================================
    # БЛОК ДЛЯ ФРОНТЕНДА (ОСНОВНОЙ)
    # Это правило должно идти последним, так как оно ловит все остальное.
    # ==========================================================
    location / {
        proxy_pass http://frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}