# Файл: backend/src/main/resources/application.yml

# ===================================================================
# KYSKFilms Backend - application.yml (ФИНАЛЬНАЯ ЧИСТАЯ ВЕРСИЯ)
# ===================================================================

# -------------------------------------------
# Spring Boot Core
# -------------------------------------------
spring:
  application:
    name: kyskfilms-backend
  liquibase:
    enabled: false

  # -------------------------------------------
  # Database Configuration
  # -------------------------------------------
  datasource:
    url: ${SPRING_DATASOURCE_URL}
    username: ${SPRING_DATASOURCE_USERNAME}
    password: ${SPRING_DATASOURCE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      connection-timeout: 30000

  # -------------------------------------------
  # JPA & Hibernate Configuration
  # -------------------------------------------
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true

  # -------------------------------------------
  # Security Configuration (OAuth2 / JWT)
  # -------------------------------------------
  security:
    oauth2:
      resourceserver:
        jwt:
          # Внешний URL для браузеров (Swagger, Frontend)
          issuer-uri: ${KEYCLOAK_ISSUER_URI}
          # Внутренний URL, который бэкенд использует для проверки токенов
          jwk-set-uri: ${KEYCLOAK_JWK_SET_URI}

# -------------------------------------------
# Server Configuration
# -------------------------------------------
server:
  port: 8081

# -------------------------------------------
# MinIO (S3 Storage) Configuration
# -------------------------------------------
minio:
  url: ${MINIO_URL}
  access-key: ${MINIO_ACCESS_KEY}
  secret-key: ${MINIO_SECRET_KEY}
  bucket: ${MINIO_BUCKET}
  region: ${MINIO_REGION}
  public:
    url: http://placeholder.com

# -------------------------------------------
# Application-specific Configuration
# -------------------------------------------
app:
  frontend:
    # Используем синтаксис YAML-списка
    allowed-origins:
      - http://localhost
      - http://localhost:3000

# -------------------------------------------
# Logging Configuration
# -------------------------------------------
logging:
  level:
    # Можно вернуть на INFO после того, как все заработает
    org.springframework.security: INFO
    org.springframework.web: INFO
    com.kyskfilms: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# -------------------------------------------
# Swagger / OpenAPI Configuration
# -------------------------------------------
springdoc:
  swagger-ui:
    path: /swagger-ui.html
    oauth:
      # Используем отдельный клиент для Swagger
      client-id: "kyskfilms-swagger"
      use-pkce-with-authorization-code-grant: true
  # Эти URL будут построены на основе issuer-uri из секции security
  oauth2:
    authorization-url: ${spring.security.oauth2.resourceserver.jwt.issuer-uri}/protocol/openid-connect/auth
    token-url: ${spring.security.oauth2.resourceserver.jwt.issuer-uri}/protocol/openid-connect/token

# -------------------------------------------
# Actuator Configuration
# -------------------------------------------
management:
  endpoints:
    web:
      exposure:
        include: health,info
      base-path: /actuator
  endpoint:
    health:
      show-details: always