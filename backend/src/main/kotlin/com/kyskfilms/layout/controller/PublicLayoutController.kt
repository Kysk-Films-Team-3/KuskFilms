package com.kyskfilms.layout.controller

import com.kyskfilms.layout.dto.*
import com.kyskfilms.title.repository.TitleRepository
import org.springframework.beans.factory.annotation.Value
import org.springframework.http.ResponseEntity
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.PathVariable
import org.springframework.web.bind.annotation.RequestMapping
import org.springframework.web.bind.annotation.RestController

@RestController
@RequestMapping("/api/public/layout")
class PublicLayoutController(
    private val titleRepository: TitleRepository,
    @Value("\${minio.public.url}") private val minioUrl: String,
    @Value("\${minio.bucket-name:images}") private val folderName: String
) {

    // ==========================================
    // 1. НОВЫЙ ЭНДПОИНТ: СЛОВАРЬ ИНТЕРФЕЙСА
    // ==========================================
    @GetMapping("/ui-dictionary")
    fun getUiDictionary(): ResponseEntity<UiDictionaryDto> {
        return ResponseEntity.ok(UiDictionaryDto(
            common = CommonUiDto(
                watchLater = "Дивитимуся",
                share = "Поділитися",
                dislike = "Не подобається",
                newBadge = "Новинка",
                starsRecommend = "Зірки рекомендують",
                newAndPopular = "Нове & Популярне",
                favorites = "Обране",
                deleteBtn = "Видалити",
                ratingLabel = "рейтинг"
            ),
            profile = ProfileUiDto(
                editTitle = "Редагування профілю",
                firstName = "Ім'я",
                lastName = "Прізвище",
                nickname = "Нікнейм",
                exit = "Вийти",
                save = "Зберегти",
                premiumActive = "Premium активний",
                premiumInactive = "Premium не активний"
            ),
            list = ListUiDto(
                title = "Список",
                persons = "Персони",
                movies = "Фільми",
                edit = "Редагувати",
                delete = "Видалити",
                save = "Зберегти",
                exit = "Вийти",
                create = "Створити",
                addMovie = "Додати фільм",
                searchMoviePlaceholder = "Введіть назву фільму",
                searchPersonPlaceholder = "Введіть ім'я актора, акторки чи режисера",
                emptyStateTitle = "Увага, виявлена помилка",
                emptyStateMessage = "Нічого не знайдено! Для точного пошуку, введіть оригінальну назву."
            ),
            editActor = EditActorUiDto(
                title = "Редагування профілю",
                mainInfo = "Основна інформація",
                name = "Ім'я",
                surname = "Прізвище",
                activityType = "Вид діяльності",
                gender = "Стать",
                birthDate = "Дата народження",
                day = "День",
                month = "Місяць",
                year = "Рік",
                birthPlace = "Місто народження",
                country = "Країна",
                city = "Місто",
                filmography = "Фільмографія",
                addMovie = "Додати фільм",
                relatives = "Родичі",
                add = "Додати",
                delete = "Видалити",
                save = "Зберегти"
            ),
            editMovie = EditMovieUiDto(
                title = "Редагування фільму",
                images = "Зображення",
                cover = "Обкладинка",
                logo = "Логотип фільму",
                background = "Фоновий постер",
                reload = "Перезавантажити",
                delete = "Видалити",
                upload = "Завантажити",
                movieTitle = "Назва фільму",
                shortDescription = "Короткий опис",
                director = "Режисер",
                directors = "Режисери фільму",
                addNewDirector = "Новий режисер",
                actors = "Актори",
                movieActors = "Актори фільму",
                year = "Рік",
                duration = "Тривалість",
                genres = "Жанри",
                categories = "Категорії",
                seasons = "Сезони",
                episodes = "Серії",
                episodeCover = "Обкладинка Серії",
                episodeTitle = "Назва Серії",
                reviews = "Відгуки",
                save = "Зберегти",
                deleteMovie = "Видалити фільм"
            ),
            searchMovie = SearchMovieUiDto(
                title = "Пошук фільму",
                placeholder = "Введіть назву фільму, серіалу або шоу",
                addMovie = "Додати фільм",
                delete = "Видалити",
                save = "Зберегти",
                emptyStateTitle = "Увага, виявлена помилка",
                emptyStateMessage = "Нічого не знайдено! Для точного пошуку, введіть оригінальну назву."
            ),
            searchActor = SearchActorUiDto(
                title = "Пошук актора",
                placeholder = "Введіть ім'я актора",
                create = "Створити",
                delete = "Видалити",
                save = "Зберегти",
                emptyStateTitle = "Увага, виявлена помилка",
                emptyStateMessage = "Нічого не знайдено! Для точного пошуку, введіть оригінальну назву."
            ),
            confirmDelete = ConfirmDeleteUiDto(
                deleteMovies = "Видалити ці фільми",
                deletePersons = "Видалити цих персон",
                confirmDeleteMovies = "Ви впевнені, що хочете видалити ці фільми?",
                confirmDeletePersons = "Ви впевнені, що хочете видалити цих персон?",
                exit = "Вийти",
                delete = "Видалити"
            )
        ))
    }

    // ==========================================
    // 2. HEADER (С НОВЫМ ПОЛЕМ)
    // ==========================================
    @GetMapping("/header")
    fun getHeaderData(): ResponseEntity<HeaderDataDto> {
        return ResponseEntity.ok(
            HeaderDataDto(
                navigation = getNavMenu(),
                searchSuggestions = getSearchSuggestions(),
                ui = HeaderUiDto(
                    premiumBtn = "Преміум",
                    promoCodeBtn = "Промокод",
                    manageProfile = "Керувати профілем",
                    switchLang = "Перемкнути на українську",
                    adminPanel = "Адмін панель",
                    logout = "Вийти",
                    loginBtn = "Увійти",
                    // НОВОЕ ПОЛЕ ИЗ ТЗ
                    searchPlaceholder = "Назва фільму, серіалу, ім'я артера, режисера"
                )
            )
        )
    }

    // ==========================================
    // 3. FOOTER (КАК БЫЛО)
    // ==========================================
    @GetMapping("/footer")
    fun getFooterData(): ResponseEntity<FooterDataDto> {
        return ResponseEntity.ok(
            FooterDataDto(
                socialLinks = getSocials(),
                columns = getFooterColumns(),
                bottomText = listOf(
                    "© 2012-2025 ТОВ «Kysk»",
                    "Загальноукраїнські канали доступні для безкоштовного перегляду цілодобово",
                    "ПЗ ТОВ «Kysk» полягає у реєстрі вітчизняного ПЗ"
                ),
                legalLinks = listOf(
                    MenuItemDto(1, "Угода користувача", "/pages/terms"),
                    MenuItemDto(2, "Політика конфіденційності", "/pages/privacy"),
                    MenuItemDto(3, "Правила рекомендацій", "/pages/rules")
                )
            )
        )
    }

    // ==========================================
    // 4. СТАТИЧЕСКИЕ СТРАНИЦЫ (КАК БЫЛО)
    // ==========================================
    @GetMapping("/pages/{slug}")
    fun getPageContent(@PathVariable slug: String): ResponseEntity<Any> {
        val content: Any? = when (slug) {
            "terms" -> LegalPageDto(
                title = "Угода користувача",
                sections = listOf(
                    LegalSectionDto("1. Загальні положення", "Ця Угода користувача (далі - «Угода») регулює відносини між ТОВ «Kysk» (далі - «Сервіс», «Ми», «Нас») та користувачем (далі - «Користувач», «Ви») щодо використання інформаційного ресурсу KyskFilms. Використовуючи наш сервіс, Ви автоматично погоджуєтесь з умовами цієї Угоди."),
                    LegalSectionDto("2. Реєстрація та обліковий запис", "Для доступу до повного функціоналу сервісу необхідно створити обліковий запис. Ви зобов'язуєтесь надавати точну та актуальну інформацію під час реєстрації. Ви несете відповідальність за збереження конфіденційності свого пароля та за всі дії, здійснені під вашим обліковим записом."),
                    LegalSectionDto("3. Використання сервісу", "Сервіс надається «як є» для особистого, некомерційного використання. Заборонено використовувати сервіс для незаконних цілей, порушення авторських прав, або будь-якої діяльності, що може завдати шкоди сервісу або іншим користувачам."),
                    LegalSectionDto("4. Підписки та оплата", "Деякі послуги можуть вимагати оплати. Умови підписки та оплати описані окремо. Ми залишаємо за собою право змінювати ціни та умови підписки з попереднім повідомленням користувачів."),
                    LegalSectionDto("5. Інтелектуальна власність", "Весь контент, доступний на платформі, включаючи фільми, серіали, зображення, логотипи та інші матеріали, є власністю їх відповідних власників та захищений законами про авторське право. Будь-яке несанкціоноване використання заборонено."),
                    LegalSectionDto("6. Зміни в Угоді", "Ми залишаємо за собою право вносити зміни до цієї Угоди. Про суттєві зміни ми повідомимо користувачів через наш сервіс або електронну пошту. Продовжуючи використовувати сервіс після змін, Ви погоджуєтесь з новими умовами.")
                )
            )
            "privacy" -> LegalPageDto(
                title = "Політика конфіденційності",
                sections = listOf(
                    LegalSectionDto("1. Збір інформації", "Ми збираємо інформацію, яку Ви надаєте нам безпосередньо (ім'я, електронна пошта, номер телефону), а також технічну інформацію про Ваш пристрій та використання сервісу (IP-адреса, тип браузера, переглянуті фільми) для покращення якості послуг."),
                    LegalSectionDto("2. Використання інформації", "Зібрана інформація використовується для надання та покращення послуг, персоналізації досвіду перегляду, обробки платежів, комунікації з користувачами та забезпечення безпеки сервісу."),
                    LegalSectionDto("3. Захист даних", "Ми вживаємо технічних та організаційних заходів для захисту Ваших персональних даних від несанкціонованого доступу, втрати або знищення. Однак жоден метод передачі через інтернет не є абсолютно безпечним."),
                    LegalSectionDto("4. Розкриття інформації третім особам", "Ми не продаємо та не передаємо Ваші персональні дані третім особам, за винятком випадків, коли це необхідно для надання послуг, виконання законних вимог, або за Вашою згодою."),
                    LegalSectionDto("5. Cookies та аналогічні технології", "Ми використовуємо cookies та аналогічні технології для збереження Ваших налаштувань, аналізу використання сервісу та персоналізації контенту. Ви можете налаштувати свій браузер для відмови від cookies, але це може вплинути на функціональність сервісу."),
                    LegalSectionDto("6. Ваші права", "Ви маєте право на доступ до своїх персональних даних, їх виправлення, видалення або обмеження обробки. Для реалізації цих прав зверніться до нас через контактну інформацію, вказану на сайті.")
                )
            )
            "rules" -> LegalPageDto(
                title = "Правила застосування рекомендаційних технологій",
                sections = listOf(
                    LegalSectionDto("1. Загальні положення", "На інформаційному ресурсі KyskFilms застосовуються рекомендаційні технології відповідно до Правил, затверджених законодавством України. Ці технології призначені для персоналізації контенту та покращення користувацького досвіду."),
                    LegalSectionDto("2. Принципи роботи рекомендаційних систем", "Рекомендаційні технології аналізують вашу історію перегляду, вподобання, рейтинги та інші поведінкові дані для формування персоналізованих рекомендацій. Система враховує жанри, акторів, режисерів та інші характеристики контенту, який ви переглядаєте."),
                    LegalSectionDto("3. Використання даних", "Для роботи рекомендаційних систем ми використовуємо анонімізовані дані про вашу активність на платформі: переглянуті фільми та серіали, додані до обраного, оцінки та інші взаємодії з контентом. Ці дані обробляються автоматично та не передаються третім особам."),
                    LegalSectionDto("4. Прозорість алгоритмів", "Ми прагнемо забезпечити прозорість роботи рекомендаційних систем. Користувачі мають можливість бачити, чому їм рекомендуються певні фільми або серіали, та впливати на формування рекомендацій через свої дії на платформі."),
                    LegalSectionDto("5. Контроль користувача", "Ви можете впливати на рекомендації, додаючи контент до обраного, ставлячи оцінки, переглядаючи різноманітний контент. Також ви маєте можливість очистити історію перегляду або скинути налаштування рекомендацій у розділі налаштувань профілю."),
                    LegalSectionDto("6. Відповідальність", "Рекомендації формуються автоматично на основі алгоритмів та не є гарантією того, що контент відповідатиме вашим очікуванням. Ми не несемо відповідальності за зміст рекомендованого контенту, але постійно працюємо над покращенням точності рекомендацій.")
                )
            )
            "devices" -> DevicesPageDto(
                title = "Список пристроїв",
                items = listOf(
                    DeviceItemDto("Смартфони", "Платформа підтримує сучасні смартфони на iOS та Android."),
                    DeviceItemDto("Комп’ютери та ноутбуки", "Працює в будь-якому сучасному браузері: Windows, macOS, Linux."),
                    DeviceItemDto("Smart TV", "Підтримуються телевізори з браузером або Android TV.")
                )
            )
            "faq" -> FaqPageDto(
                title = "Питання та відповіді",
                items = listOf(
                    FaqItemDto("Що таке Kysk?", "Kysk — це сучасний український стримінговий сервіс для перегляду фільмів і серіалів у зручному та високоякісному форматі."),
                    FaqItemDto("Як оформити підписку?", "Перейдіть у розділ «Преміум», оберіть тариф та здійсніть оплату. Підписка активується миттєво."),
                    FaqItemDto("Чи можна користуватися Kysk без підписки?", "Так, частина контенту доступна безкоштовно. Але преміум-підписка відкриває додаткові можливості, ексклюзиви та перегляд без реклами."),
                    FaqItemDto("Чи безпечно зберігати платіжні дані в Kysk?", "Так. Дані зашифровані, не зберігаються у відкритому вигляді та обробляються виключно сертифікованими міжнародними платіжними системами."),
                    FaqItemDto("Чи є субтитри та різні аудіодоріжки?", "Так. Багато фільмів мають українську та оригінальну аудіодоріжки, а також субтитри. Ми постійно розширюємо доступність контенту."),
                    FaqItemDto("Як скасувати підписку?", "У вашому профілі є розділ «Керування підпискою», де ви можете вимкнути автоматичне поновлення в будь-який час.")
                )
            )
            "about" -> AboutPageDto(
                title = "Про KyskFilms",
                description = "KyskFilms — це сучасний стримінговий сервіс, створений для людей, які цінують якісний контент, зручний інтерфейс та високі стандарти перегляду. Ми поєднуємо стильний дизайн, продуману навігацію та рекомендації, що працюють саме для вас.",
                missionTitle = "Наша місія",
                missionText = "Ми прагнемо зробити кіно ближчим, доступнішим і приємнішим для кожного глядача. Наша мета — забезпечити комфортне середовище для перегляду улюблених фільмів і серіалів без зайвих перешкод.",
                valuesTitle = "Наші цінності",
                values = listOf("Якість — від інтерфейсу до стриму.", "Зручність використання.", "Прозорість та відкритість.", "Користувач у центрі уваги.", "Повага до контенту та авторського права."),
                teamTitle = "Команда",
                teamText = "Ми — молода команда розробників, дизайнерів та ентузіастів, яка прагне створити найкращу українську платформу для перегляду фільмів. Ваш комфорт — наше натхнення."
            )
            "careers" -> CareersPageDto(
                title = "Кар’єра в Kysk",
                intro = "Ми створюємо сучасний український стримінговий сервіс і шукаємо талановитих людей, які хочуть разом з нами формувати майбутнє кінорозваг.",
                whyTitle = "Чому Kysk?",
                reasons = listOf("Можливість впливати на ключові рішення продукту.", "Надихаюча та підтримуюча команда.", "Сучасний технологічний стек.", "Гнучкий графік та віддалена робота.", "Продукт, яким користуються тисячі людей."),
                vacanciesTitle = "Відкриті вакансії",
                vacancies = listOf(
                    VacancyDto("Frontend-розробник (React)", "Створення інтерфейсу, UI-компонентів, оптимізація продуктивності, робота з відеоплеєром та модулем рекомендацій."),
                    VacancyDto("Backend-розробник (Node.js/Kotlin)", "Робота над API, системою рекомендацій, авторизацією, аналітикою та масштабуванням сервісу."),
                    VacancyDto("UI/UX дизайнер", "Розробка інтерфейсів, покращення користувацького досвіду, створення нової візуальної айдентики Kysk.")
                ),
                notFoundTitle = "Не знайшли свою роль?",
                notFoundText = "Ми завжди відкриті до талановитих людей. Надішліть своє резюме на нашу пошту — і ми обов’язково розглянемо вашу кандидатуру.",
                sendResumeBtn = "Надіслати резюме"
            )
            "distributors" -> DistributorsPageDto(
                title = "Для дистриб’юторів",
                cooperationTitle = "Співпраця з Kysk",
                cooperationDesc = "Ми відкриті до партнерства з дистриб’юторами та правовласниками, які бажають розмістити свій контент на нашій платформі.",
                requirementsTitle = "Наші вимоги",
                requirementsDesc = "Ми працюємо виключно з легальним контентом, на який наявні всі необхідні права. Перевага надається матеріалам у високій якості (FullHD / UHD), а також за наявності метаданих та локалізації.",
                offerTitle = "Що ми пропонуємо",
                offerDesc = "Розміщення контенту на сучасній платформі з прозорою аналітикою, захистом від піратства та доступом до широкої української аудиторії.",
                contactTitle = "Зв’яжіться з нами",
                contactDesc = "Напишіть нам на корпоративну адресу — і ми оперативно відповімо, обговоримо умови співпраці та допоможемо розмістити ваш контент.",
                sendProposalBtn = "Надіслати пропозицію"
            )
            "contacts" -> ContactsPageDto(
                title = "Контакти",
                lead = "З будь-яких питань щодо сервісу, пропозицій або співпраці — ми завжди на зв’язку.",
                writeQuestionBtn = "Написати запитання",
                responseTime = "Відповідаємо протягом 24 годин."
            )
            "promo" -> PromoOffersPageDto(
                title = "Акції та пропозиції",
                subtitle = "Вигідні преміум-пропозиції та ексклюзивні промокоди.",
                premiumTitle = "Преміум зі знижкою",
                premiumText = "Повний доступ до каталогу, 4K та перегляд без реклами.",
                buyPremiumBtn = "Купити Преміум",
                copiedMsg = "Скопійовано ✔️",
                copyBtn = "Скопіювати",
                promos = listOf(PromoItemDto("KYSK25", "-30% для нових користувачів"), PromoItemDto("FREEWEEK", "7 днів преміум безкоштовно"))
            )
            "agents" -> AgentsPageDto(
                title = "Агенти Kysk",
                intro = "Агенти Kysk — це люди, які допомагають нам створювати найкращий кіно-досвід в Україні. Вони тестують новий функціонал, пропонують фільми, перевіряють якість контенту та підтримують спільноту.",
                whoAreAgentsTitle = "Хто такі агенти?",
                whoAreAgentsText = "Це команда ентузіастів та експертів, які мають доступ до ранніх оновлень, закритих тестувань та внутрішніх інструментів Kysk. Кожен агент впливає на те, яким буде наш сервіс завтра.",
                rolesTitle = "Ролі агентів",
                roles = listOf(
                    AgentRoleDto("Контент-скаут", "Шукає нові фільми, серіали та тренди. Пропонує контент для платформи."),
                    AgentRoleDto("Тестер продукту", "Перевіряє новий функціонал, знаходить помилки та оцінює зручність і продуктивність."),
                    AgentRoleDto("Аналітик рекомендацій", "Допомагає покращувати систему персональних рекомендацій через зворотний зв’язок та аналітику."),
                    AgentRoleDto("Модератор спільноти", "Підтримує здорову атмосферу, допомагає користувачам і відповідає на запитання.")
                ),
                howToTitle = "Як стати агентом?",
                howToText = "Ми відбираємо найактивніших користувачів та людей з досвідом у медіа, аналітиці, дизайні або розробці. Хочеш приєднатися?",
                applyButton = "Подати заявку"
            )
            else -> null
        }

        return if (content != null) ResponseEntity.ok(content) else ResponseEntity.notFound().build()
    }

    // ==========================================
    // 5. PRIVATE HELPERS
    // ==========================================
    private fun resolveImageUrl(path: String?): String {
        if (path.isNullOrBlank()) return ""
        if (path.startsWith("http")) return path
        return "$minioUrl/$folderName/$path"
    }

    private fun getNavMenu(): List<MenuItemDto> {
        return listOf(
            MenuItemDto(1, "Головна", "/"),
            MenuItemDto(2, "Каталог", "/catalog"),
            MenuItemDto(3, "Нове і Популярне", "/new"),
            MenuItemDto(4, "Обране", "/favorites")
        )
    }

    private fun getSearchSuggestions(): SearchSuggestionsDto {
        val titles = titleRepository.findAll().take(3)
        val items = titles.map { title ->
            SearchItemDto(
                id = title.id?.toLong() ?: 0L,
                title = title.title,
                subtitle = title.releaseDate?.year?.toString() ?: "Фільм",
                imageUrl = resolveImageUrl(title.posterUrl),
                type = "MOVIE"
            )
        }.toMutableList()

        items.add(
            SearchItemDto(
                id = 55,
                title = "Кіану Рівз",
                subtitle = "Актор",
                imageUrl = "$minioUrl/$folderName/actors/keanu.jpg",
                type = "ACTOR"
            )
        )

        return SearchSuggestionsDto("Часто шукають", items)
    }

    private fun getSocials(): List<SocialLinkDto> {
        return listOf(
            SocialLinkDto("tg", "https://t.me/kyskfilms"),
            SocialLinkDto("fb", "https://facebook.com/kyskfilms"),
            SocialLinkDto("ig", "https://instagram.com/kyskfilms"),
            SocialLinkDto("x", "https://twitter.com/kyskfilms")
        )
    }

    private fun getFooterColumns(): List<FooterColumnDto> {
        return listOf(
            FooterColumnDto("Kysk", listOf(
                MenuItemDto(1, "Про нас", "/pages/about"),
                MenuItemDto(2, "Кар'єра в Kysk", "/pages/careers"),
                MenuItemDto(3, "Агенти Kysk", "/pages/agents")
            )),
            FooterColumnDto("Допомога", listOf(
                MenuItemDto(4, "Запитання та відповіді", "/pages/faq"),
                MenuItemDto(5, "Список пристроїв", "/pages/devices"),
                MenuItemDto(6, "Дистриб'юторам", "/pages/distributors"),
                MenuItemDto(7, "Контакти", "/pages/contacts")
            )),
            FooterColumnDto("Інше", listOf(
                MenuItemDto(8, "Акції та пропозиції", "/pages/promo")
            ))
        )
    }
}